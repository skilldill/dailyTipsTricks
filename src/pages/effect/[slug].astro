---
import BaseLayout from '../../layouts/BaseLayout.astro';
import EffectPreview from '../../components/EffectPreview.astro';
import fs from 'node:fs/promises';
import path from 'node:path';

const humanize = (name) =>
  name
    .replace(/[^a-zA-Z0-9]+/g, ' ')
    .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
    .replace(/([a-zA-Z])([0-9])/g, '$1 $2')
    .replace(/([0-9])([a-zA-Z])/g, '$1 $2')
    .trim()
    .replace(/\s+/g, ' ')
    .replace(/\b\w/g, (m) => m.toUpperCase());

const extractBody = (raw) => {
  const bodyMatch = raw.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
  const body = bodyMatch ? bodyMatch[1] : raw;
  return body
    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
    .replace(/<link[^>]*rel=["']stylesheet["'][^>]*>/gi, '')
    .trim();
};

const readEffect = async (slug) => {
  const effectsRoot = path.join(process.cwd(), 'effectsTipsTricks');
  const dir = path.join(effectsRoot, slug);
  const indexPath = path.join(dir, 'index.html');
  const cssPath = path.join(dir, 'styles.css');
  const jsPath = path.join(dir, 'script.js');

  let html = '';
  let css = '';
  let js = '';

  try {
    const raw = await fs.readFile(indexPath, 'utf-8');
    html = extractBody(raw);

    const inlineStyles = raw.match(/<style[^>]*>([\s\S]*?)<\/style>/gi) || [];
    css += inlineStyles.map((s) => s.replace(/<\/?style[^>]*>/gi, '')).join('\n');

    const inlineScripts = raw.match(/<script(?![^>]*src)[^>]*>([\s\S]*?)<\/script>/gi) || [];
    js += inlineScripts.map((s) => s.replace(/<\/?script[^>]*>/gi, '')).join('\n');
  } catch {
    // ignore
  }

  try {
    const cssFile = await fs.readFile(cssPath, 'utf-8');
    css += `\n${cssFile}`;
  } catch {
    // ignore
  }

  try {
    const jsFile = await fs.readFile(jsPath, 'utf-8');
    js += `\n${jsFile}`;
  } catch {
    // ignore
  }

  return { html, css, js };
};

export async function getStaticPaths() {
  const effectsRoot = path.join(process.cwd(), 'effectsTipsTricks');
  const entries = await fs.readdir(effectsRoot, { withFileTypes: true });
  const slugs = [];

  for (const entry of entries) {
    if (!entry.isDirectory() || entry.name.startsWith('.')) continue;
    try {
      await fs.access(path.join(effectsRoot, entry.name, 'index.html'));
      slugs.push(entry.name);
    } catch {
      // ignore
    }
  }

  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const title = humanize(slug);
const { html, css, js } = await readEffect(slug);
const githubUrl = `https://github.com/skilldill/dailyTipsTricks/tree/main/effectsTipsTricks/${slug}`;
---

<BaseLayout title={`${title} — Daily Tips & Tricks`}>
  <section class="effect-page">
    <div class="effect-header">
      <div>
        <p class="eyebrow">UI Effect</p>
        <h1>{title}</h1>
        <p class="hero-text">Полноразмерный просмотр эффекта.</p>
      </div>
      <div class="effect-actions">
        <a class="secondary-button" href="/">Назад</a>
        <a class="primary-button" href={githubUrl} target="_blank" rel="noreferrer">Открыть на GitHub</a>
      </div>
    </div>

    <div class="effect-stage">
      <EffectPreview html={html} css={css} js={js} slug={slug} />
    </div>

    <div class="effect-footer">
      <a class="ghost-button" href={githubUrl} target="_blank" rel="noreferrer">Перейти в репозиторий эффекта</a>
    </div>
  </section>
</BaseLayout>
